---
title: "LMMvsGMM"
author: "Pietro Viacava"
date: "15/02/2021"
output: html_document
---
  
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '../Viacavaetal_LMMvsGMM/Data', echo = FALSE)

#load libraries

library(MASS)
library(car)
library(ggplot2)
library(geomorph)
library(klaR)
library(EnvStats)
library(dplyr)
library(Morpho)


```


```{r, load 3D landmark data and perform gpa, include=FALSE}

#Import 3D coordinates from all specimens

coords.3D <- t (read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/Antechinus_semiLMcoords.csv", header = TRUE, row.names = 1))
dim(coords.3D) #check number of specimens and landmarks

#Convert 2D metadata into a 3D array

A <- arrayspecs(coords.3D, 412, 3)
dim(A)
Ahead <- head(dimnames(A))[3]

#Load the classifier

antechinusdata <- read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/Viacavaetal_LMMvsGMM_data.csv", header=T)
dim(antechinusdata) #check number of specimens


#give museum ID row names to antechinus data

rownames(antechinusdata)<-antechinusdata$ID

#Rearrange coordinate names and classifier file names in the same order

names_array <- dimnames(A)[[3]]
names_classifier <- rownames(antechinusdata)
match(names_array, names_classifier)
A_reorder <- A[,,match(names_classifier, names_array)]

names_Areorder <- dimnames(A_reorder)[[3]]
match(names_Areorder, names_classifier) #checking that the ID's correspond in both

#clean dataset, delete juveniles, other species and CM3642 for being a clear outlier

A_reorder <- A_reorder[,,-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642"))]

antechinusdata <- antechinusdata[-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642")),]
antechinusdata <- droplevels(antechinusdata) #we end up with 168 specimens


#load data of specimens with known population

A_reorderpop <- A_reorder[,,-c(which(antechinusdata$Population=="?"))]

antechinusdatapop <- antechinusdata[-c(which(antechinusdata$Population=="?")),]
antechinusdatapop <- droplevels(antechinusdatapop)


gpaallpop<-gpagen(A_reorderpop, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                  max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)


```


```{r, extraction of linear measurements, include=FALSE}

#calculate linear measurements following the protocol of Van Dyck & Crowther, 2000

vandyck2000 <- data.frame(bl = (interlmkdist(A_reorder,c(6,10))), 
                          pl = (interlmkdist(A_reorder,c(7,10))), 
                          p1_3 = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                          swr_lc1a = (interlmkdist(A_reorder,c(25,26))),
                          c1m4 = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                          ipvl = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                          swr_lm3 = (interlmkdist(A_reorder,c(41,42))),
                          tc = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                          ibw = (interlmkdist(A_reorder,c(65,66))),
                          obw = (interlmkdist(A_reorder,c(45,46))),
                          apvl = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                          ppvl = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                          m1_4 = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2)



#calculate linear measurements following the protocol of Dickman et al., 1998

dickman1998 <- data.frame(con = (interlmkdist(A_reorder,c(6,10))), 
                          pal = (interlmkdist(A_reorder,c(7,10))), 
                          p1_3 = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                          swc = (interlmkdist(A_reorder,c(25,26))),
                          c1m4 = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                          m1_4 = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                          ipd = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                          swm3 = (interlmkdist(A_reorder,c(41,42))),
                          aw = (interlmkdist(A_reorder,c(71,72))),
                          tcd = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                          ibw = (interlmkdist(A_reorder,c(65,66))),
                          obm = (interlmkdist(A_reorder,c(45,46))),
                          pns = (interlmkdist(A_reorder,c(11,17)) + interlmkdist(A_reorder,c(12,18)))/2,
                          nwi = (interlmkdist(A_reorder,c(11,12))),
                          nl = (interlmkdist(A_reorder,c(1,2))),
                          now = (interlmkdist(A_reorder,c(19,20))),
                          gl = (interlmkdist(A_reorder,c(4,10))),
                          apv = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                          ppv = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                          fmh = (interlmkdist(A_reorder,c(5,6))),
                          fmw = (interlmkdist(A_reorder,c(55,56))))



#calculate linear measurements following the protocol of Baker et al., 2013

baker2013 <- data.frame(ht_b = sqrt(interlmkdist(A_reorder,c(3,69)))^2 - ((interlmkdist(A_reorder,c(69,70)))/2)^2, 
                        uml = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                        upl = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                        pml = sqrt(interlmkdist(A_reorder,c(10,17)))^2 - ((interlmkdist(A_reorder,c(17,18)))/2)^2,
                        I1_P3 = (interlmkdist(A_reorder,c(10,27)) + interlmkdist(A_reorder,c(10,28)))/2,
                        nw = (interlmkdist(A_reorder,c(17,18))),
                        nwr = (interlmkdist(A_reorder,c(19,20))),
                        apv = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                        ipv = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                        ppv = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                        pl = (interlmkdist(A_reorder,c(7,10))),
                        bl = (interlmkdist(A_reorder,c(6,10))),
                        tc = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                        ibw = (interlmkdist(A_reorder,c(65,66))),
                        R_LC1 = (interlmkdist(A_reorder,c(25,26))),
                        R_LM1T = (interlmkdist(A_reorder,c(27,28))),
                        R_LM3 = (interlmkdist(A_reorder,c(41,42))),
                        OBW = (interlmkdist(A_reorder,c(45,46))))



#calculate linear measurements following the protocol of Travouillon, 2016

travouillon2016 <- data.frame(onl = (interlmkdist(A_reorder,c(1,4))),
                              nl = (interlmkdist(A_reorder,c(2,10))),
                              anw = (interlmkdist(A_reorder,c(11,12))),
                              nps = (interlmkdist(A_reorder,c(11,17)) + interlmkdist(A_reorder,c(12,18)))/2,
                              pnw = (interlmkdist(A_reorder,c(19,20))),
                              rwi = (interlmkdist(A_reorder,c(29,31)) + interlmkdist(A_reorder,c(30,32)))/2,
                              fs = (interlmkdist(A_reorder,c(2,3))),
                              ppw = (interlmkdist(A_reorder,c(23,24))),
                              bcl = (interlmkdist(A_reorder,c(5,10))),
                              il = (interlmkdist(A_reorder,c(10,15)) + interlmkdist(A_reorder,c(10,16)))/2,
                              apw = (interlmkdist(A_reorder,c(79,80)) + interlmkdist(A_reorder,c(81,82)))/2,
                              apl = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                              rwc = (interlmkdist(A_reorder,c(25,26))),
                              upr = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                              ctl = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                              umr = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                              op3 = (interlmkdist(A_reorder,c(27,28))),
                              ppl = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                              bol = (interlmkdist(A_reorder,c(61,65)) + interlmkdist(A_reorder,c(62,66)))/2,
                              mw = (interlmkdist(A_reorder,c(47,49))),
                              pow = (interlmkdist(A_reorder,c(59,60))),
                              cw = (interlmkdist(A_reorder,c(57,58))))



```


```{r, PCAs of raw LMM data from the four LMM protocols, include=FALSE}


#PCA for van dyck & crowther, 2000

PCAvd00raw <-prcomp(vandyck2000[-c(which(antechinusdata$Population=="?")),])
summary(PCAvd00raw)

dataPCAvd00raw <- data.frame(-PCAvd00raw$x[,1], PCAvd00raw$x[,2], antechinusdatapop$Population)

plotPCAvd00raw <- ggplot(dataPCAvd00raw, aes(x=X.PCAvd00raw.x...1., y=PCAvd00raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (81.54%)", y = "PC 2 (10.73%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00raw)


#PCA for dickman et al., 1998

PCAd98raw <- prcomp(dickman1998[-c(which(antechinusdata$Population=="?")),])
summary(PCAd98raw)

dataPCAd98raw <- data.frame(-PCAd98raw$x[,1], PCAd98raw$x[,2], antechinusdatapop$Population)

plotPCAd98raw <- ggplot(dataPCAd98raw, aes(x=X.PCAd98raw.x...1., y=-PCAd98raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (77.55%)", y = "PC 2 (8.8%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98raw)


#PCA for baker et al., 2013

PCAb13raw <- prcomp(baker2013[-c(which(antechinusdata$Population=="?")),])
summary(PCAb13raw)

dataPCAb13raw <- data.frame(-PCAb13raw$x[,1], -PCAb13raw$x[,2], antechinusdatapop$Population)

plotPCAb13raw <- ggplot(dataPCAb13raw, aes(x=X.PCAb13raw.x...1., y=X.PCAb13raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (75.82%)", y = "PC 2 (9.74%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13raw)


#PCA for travouillon, 2016

PCAt16raw <- prcomp(travouillon2016[-c(which(antechinusdata$Population=="?")),])
summary(PCAt16raw)

dataPCAt16raw <- data.frame(-PCAt16raw$x[,1], PCAt16raw$x[,2], antechinusdatapop$Population)

plotPCAt16raw <- ggplot(dataPCAt16raw, aes(x=X.PCAt16raw.x...1., y=PCAt16raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (73.36%)", y = "PC 2 (7.71%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16raw)



```

```{r, PCAs of size-free LMM data from the four LMM protocols, include=FALSE}


#van dyck & crowther, 2000

#calculation of the geometric mean for each specimen

gmeansvd00 <- apply(vandyck2000, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.vd00 <- log10(vandyck2000/gmeansvd00)

#integration into a dataframe with information on population ID

sizefree_dfvd00 <- data.frame(shaperatio.vd00, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAvd00sf <- prcomp(sizefree_dfvd00[-c(which(antechinusdata$Population=="?")),1:13])
summary(PCAvd00sf)


dataPCAvd00 <- data.frame(PCAvd00sf$x[,1], PCAvd00sf$x[,2], antechinusdatapop$Population)

plotPCAvd00 <- ggplot(dataPCAvd00, aes(x=PCAvd00sf.x...1., y=PCAvd00sf.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (89.12%)", y = "PC 2 (3.23%)") +
  scale_color_manual(values = c( "#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00)

#dickman et al., 1998

#calculation of the geometric mean for each specimen

gmeansd98 <- apply(dickman1998, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.d98 <- log10(dickman1998/gmeansd98) 

#integration into a dataframe with information on population ID

sizefree_dfd98 <- data.frame(shaperatio.d98, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAd98sf <- prcomp(sizefree_dfd98[-c(which(antechinusdata$Population=="?")),1:21])
summary(PCAd98sf)

dataPCAd98 <- data.frame(PCAd98sf$x[,1], PCAd98sf$x[,2], antechinusdatapop$Population)

plotPCAd98 <- ggplot(dataPCAd98, aes(x=PCAd98sf.x...1., y=PCAd98sf.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (75.67%)", y = "PC 2 (4.55%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98)

#PCA for baker et al., 2013

#calculation of the geometric mean for each specimen

gmeansb13 <- apply(baker2013, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.b13 <- log10(baker2013/gmeansb13) 

#integration into a dataframe with information on population ID

sizefree_dfb13 <- data.frame(shaperatio.b13, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAb13sf <- prcomp(sizefree_dfb13[-c(which(antechinusdata$Population=="?")),1:18])
summary(PCAb13sf)

dataPCAb13 <- data.frame(PCAb13sf$x[,1], PCAb13sf$x[,2], antechinusdatapop$Population)

plotPCAb13 <- ggplot(dataPCAb13, aes(x=PCAb13sf.x...1., y=PCAb13sf.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (78.13%)", y = "PC 2 (6.26%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13)


#travouillon, 2016

#calculation of the geometric mean for each specimen

gmeanst16 <- apply(travouillon2016, 1, geoMean)

#freeing size with calculation of shape ratios

shaperatio.t16 <- log10(travouillon2016/gmeanst16) 

#integration into a dataframe with information on population ID

sizefree_dft16 <- data.frame(shaperatio.t16, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAt16sf <- prcomp(sizefree_dft16[-c(which(antechinusdata$Population=="?")),1:22])
summary(PCAt16sf)

dataPCAt16 <- data.frame(PCAt16sf$x[,1], PCAt16sf$x[,2], antechinusdatapop$Population)

plotPCAt16 <- ggplot(dataPCAt16, aes(x=PCAt16sf.x...1., y=-PCAt16sf.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (38.33%)", y = "PC 2 (12.2%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16)

```

```{r, PCAs of allometry-free LMM data from the four LMM protocols, include=FALSE}

#checking for allometry in vd00

gmeansvd00.pop <- as.data.frame(gmeansvd00[-c(which(antechinusdata$Population=="?"))])
names(gmeansvd00.pop)[names(gmeansvd00.pop) == 'gmeansvd00[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansvd00.pop'

rdf.vd00 <- rrpp.data.frame(cbind(sizefree_dfvd00[-c(which(antechinusdata$Population=="?")),1:13], gmeansvd00.pop))

fitdata.vd00 <- as.matrix(cbind(rdf.vd00$bl, rdf.vd00$pl, rdf.vd00$p1_3, rdf.vd00$swr_lc1a, rdf.vd00$c1m4, rdf.vd00$ipvl, rdf.vd00$swr_lm3, rdf.vd00$tc, rdf.vd00$ibw, rdf.vd00$obw, rdf.vd00$apvl, rdf.vd00$ppvl, rdf.vd00$m1_4))

rdf.vd00$LMM <- fitdata.vd00

fit.vd00 <- lm.rrpp(LMM~log(gmeansvd00.pop), data = rdf.vd00, iter = 999)

anova(fit.vd00)

#PCA of allometry-corrected data in vd00

PCAvd00ac <- prcomp(fit.vd00$LM$residuals)


summary(PCAvd00ac)

dataPCAvd00ac <- data.frame(PCAvd00ac$x[,1], PCAvd00ac$x[,2], antechinusdatapop$Population)

plotPCAvd00ac <- ggplot(dataPCAvd00ac, aes(x=PCAvd00ac.x...1., y=PCAvd00ac.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (88.64%)", y = "PC 2 (3.42%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00ac)


#checking for allometry in d98

gmeansd98.pop <- as.data.frame(gmeansd98[-c(which(antechinusdata$Population=="?"))])
names(gmeansd98.pop)[names(gmeansd98.pop) == 'gmeansd98[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansd98.pop'

rdf.d98 <- rrpp.data.frame(cbind(sizefree_dfd98[-c(which(antechinusdata$Population=="?")),1:21], gmeansd98.pop))

fitdata.d98 <- as.matrix(cbind(rdf.d98$con, rdf.d98$pal, rdf.d98$p1_3, rdf.d98$swc, rdf.d98$c1m4, rdf.d98$m1_4, rdf.d98$ipd, rdf.d98$swm3, rdf.d98$aw, rdf.d98$tcd, rdf.d98$ibw, rdf.d98$obm, rdf.d98$pns, rdf.d98$nwi, rdf.d98$nl, rdf.d98$now, rdf.d98$gl, rdf.d98$apv, rdf.d98$ppv, rdf.d98$fmh, rdf.d98$fmw))

rdf.d98$LMM <- fitdata.d98

fit.d98 <- lm.rrpp(LMM~log(gmeansd98.pop), data = rdf.d98)

anova(fit.d98)

#PCA of allometry-corrected data in d98

PCAd98ac <- prcomp(fit.d98$LM$residuals)


summary(PCAd98ac)

dataPCAd98ac <- data.frame(PCAd98ac$x[,1], PCAd98ac$x[,2], antechinusdatapop$Population)

plotPCAd98ac <- ggplot(dataPCAd98ac, aes(x=PCAd98ac.x...1., y=-PCAd98ac.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (73.87%)", y = "PC 2 (4.89%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98ac)



#checking for allometry in b13

gmeansb13.pop <- as.data.frame(gmeansb13[-c(which(antechinusdata$Population=="?"))])
names(gmeansb13.pop)[names(gmeansb13.pop) == 'gmeansb13[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansb13.pop'

rdf.b13 <- rrpp.data.frame(cbind(sizefree_dfb13[-c(which(antechinusdata$Population=="?")),1:18], gmeansb13.pop))

fitdata.b13 <- as.matrix(cbind(rdf.b13$ht_b, rdf.b13$uml, rdf.b13$upl, rdf.b13$pml, rdf.b13$I1_P3, rdf.b13$nw, rdf.b13$nwr, rdf.b13$apv, rdf.b13$ipv, rdf.b13$ppv, rdf.b13$pl, rdf.b13$bl, rdf.b13$tc, rdf.b13$ibw, rdf.b13$R_LC1, rdf.b13$R_LM1T, rdf.b13$R_LM3, rdf.b13$OBW))

rdf.b13$LMM <- fitdata.b13

fit.b13 <- lm.rrpp(LMM~log(gmeansb13.pop), data = rdf.b13)

anova(fit.b13)

#PCA of allometry-corrected data in b13

PCAb13ac <- prcomp(fit.b13$LM$residuals)


summary(PCAb13ac)

dataPCAb13ac <- data.frame(PCAb13ac$x[,1], PCAb13ac$x[,2], antechinusdatapop$Population)

plotPCAb13ac <- ggplot(dataPCAb13ac, aes(x=PCAb13ac.x...1., y=-PCAb13ac.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (76.36%)", y = "PC 2 (6.88%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13ac)


#checking for allometry in t16

gmeanst16.pop <- as.data.frame(gmeanst16[-c(which(antechinusdata$Population=="?"))])
names(gmeanst16.pop)[names(gmeanst16.pop) == 'gmeanst16[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeanst16.pop'

rdf.t16 <- rrpp.data.frame(cbind(sizefree_dft16[-c(which(antechinusdata$Population=="?")),1:22], gmeanst16.pop))

fitdata.t16 <- as.matrix(cbind(rdf.t16$onl, rdf.t16$nl, rdf.t16$anw, rdf.t16$nps, rdf.t16$pnw, rdf.t16$rwi, rdf.t16$fs, rdf.t16$ppw, rdf.t16$bcl, rdf.t16$il, rdf.t16$apw, rdf.t16$apl, rdf.t16$rwc, rdf.t16$upr, rdf.t16$ctl, rdf.t16$umr, rdf.t16$op3, rdf.t16$ppl, rdf.t16$bol, rdf.t16$mw, rdf.t16$pow, rdf.t16$cw))

rdf.t16$LMM <- fitdata.t16

fit.t16 <- lm.rrpp(LMM~log(gmeanst16.pop), data = rdf.t16)

anova(fit.t16)

#PCA of allometry-corrected data in t16

PCAt16ac <- prcomp(fit.t16$LM$residuals)


summary(PCAt16ac)

dataPCAt16ac <- data.frame(PCAt16ac$x[,1], PCAt16ac$x[,2], antechinusdatapop$Population)

plotPCAt16ac <- ggplot(dataPCAt16ac, aes(x=PCAt16ac.x...1., y=PCAt16ac.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (24.61%)", y = "PC 2 (15.16%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16ac)


```

```{r, PCAs for GMM data, include = FALSE}

#PCA of raw GMM data (unscaled or partial Procrustes superimposition)

gpapproc <- ProcGPA(A_reorderpop, scale = FALSE)

PCAgmmraw <- gm.prcomp(gpapproc$rotated)
summary(PCAgmmraw)


dataPCAgmmraw <- data.frame(-PCAgmmraw$x[,1], PCAgmmraw$x[,2], antechinusdatapop$Population)

plotPCAgmmraw <- ggplot(dataPCAgmmraw, aes(x=X.PCAgmmraw.x...1., y=-PCAgmmraw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (78.77%)", y = "PC 2 (3.12%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmraw)

#PCA of GMM data after Procrustes superimposition

PCAgmmgpa <- gm.prcomp(gpaallpop$coords) 

summary(PCAgmmgpa)

dataPCAgmmgpa <- data.frame(PCAgmmgpa$x[,1], -PCAgmmgpa$x[,2], antechinusdatapop$Population)

plotPCAgmmgpa <- ggplot(dataPCAgmmgpa, aes(x=PCAgmmgpa.x...1., y=X.PCAgmmgpa.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (19.43%)", y = "PC 2 (10.71%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmgpa)

#PCA of GMM data after allometric correction

fit.sizegmm <- procD.lm(f1 = gpaallpop$coords~log(gpaallpop$Csize),  print.progress = FALSE)

PCAgmmresiduals <- gm.prcomp(fit.sizegmm$residuals)
summary(PCAgmmresiduals)

dataPCAgmmresiduals <- data.frame(PCAgmmresiduals$x[,1], PCAgmmresiduals$x[,2], antechinusdatapop$Population)

plotPCAgmmresiduals <- ggplot(dataPCAgmmresiduals, aes(x=PCAgmmresiduals.x...1., y=PCAgmmresiduals.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (14.78%)", y = "PC 2 (11.27%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmresiduals)


```


```{r, PCA Figure, include = FALSE}

library(ggpubr)

PCAfigs <- ggarrange(plotPCAvd00raw, plotPCAvd00, plotPCAvd00ac, plotPCAd98raw, plotPCAd98, plotPCAd98ac, plotPCAb13raw, plotPCAb13, plotPCAb13ac, plotPCAt16raw, plotPCAt16, plotPCAt16ac, plotPCAgmmraw, plotPCAgmmgpa, plotPCAgmmresiduals, nrow = 5, ncol = 3, common.legend = TRUE, legend = "bottom")

plot(PCAfigs) 

```


```{r, LDAs of raw LMM data from the four LMM protocols, include=FALSE}

#LDA of raw LMM data for vd00

summary(PCAvd00raw) #determine the number of PCs to be used (95% of cumulative proportion)

PCvd00raw <- data.frame(PCAvd00raw$x[,1:4]) 

PCvd00raw$Population <- antechinusdatapop$Population

ldavd00raw <- lda(Population~., data = PCvd00raw, prior = c(1,1,1)/3)

ldsvd00raw <- predict(ldavd00raw)

dataldavd00raw <- data.frame(ldsvd00raw$x[,1], ldsvd00raw$x[,2], PCvd00raw$Population)

plotldavd00raw <- ggplot(dataldavd00raw, aes(x=-ldsvd00raw.x...1., y=-ldsvd00raw.x...2., colour = PCvd00raw.Population)) +
  labs(x = "LD 1 (86.79%)", y = "LD 2 (13.21%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldavd00raw)


#LDA of raw LMM data for d98

summary(PCAd98raw) #determine the number of PCs to be used (95% of cumulative proportion)

PCd98raw <- data.frame(PCAd98raw$x[,1:7]) 

PCd98raw$Population <- antechinusdatapop$Population

ldad98raw <- lda(Population~., data = PCd98raw, prior = c(1,1,1)/3)

ldsd98raw <- predict(ldad98raw)

dataldad98raw <- data.frame(ldsd98raw$x[,1], ldsd98raw$x[,2], PCd98raw$Population)

plotldad98raw <- ggplot(dataldad98raw, aes(x=ldsd98raw.x...1., y=ldsd98raw.x...2., colour = PCd98raw.Population)) +
  labs(x = "LD 1 (83.98%)", y = "LD 2 (16.02%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldad98raw)


#LDA of raw LMM data for b13

summary(PCAb13raw) #determine the number of PCs to be used (95% of cumulative proportion)

PCb13raw <- data.frame(PCAb13raw$x[,1:6]) 

PCb13raw$Population <- antechinusdatapop$Population

ldab13raw <- lda(Population~., data = PCb13raw, prior = c(1,1,1)/3)

ldsb13raw <- predict(ldab13raw)

dataldab13raw <- data.frame(ldsb13raw$x[,1], ldsb13raw$x[,2], PCb13raw$Population)

plotldab13raw <- ggplot(dataldab13raw, aes(x=ldsb13raw.x...1., y=ldsb13raw.x...2., colour = PCb13raw.Population)) +
  labs(x = "LD 1 (88.48%)", y = "LD 2 (11.52%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldab13raw)


#LDA of raw LMM data for t16

summary(PCAt16raw) #determine the number of PCs to be used (95% of cumulative proportion)

PCt16raw <- data.frame(PCAt16raw$x[,1:9]) 

PCt16raw$Population <- antechinusdatapop$Population

ldat16raw <- lda(Population~., data = PCt16raw, prior = c(1,1,1)/3)

ldst16raw <- predict(ldat16raw)

dataldat16raw <- data.frame(ldst16raw$x[,1], ldst16raw$x[,2], PCt16raw$Population)

plotldat16raw <- ggplot(dataldat16raw, aes(x=ldst16raw.x...1., y=ldst16raw.x...2., colour = PCt16raw.Population)) +
  labs(x = "LD 1 (80.29%)", y = "LD 2 (19.71%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldat16raw)


```

```{r, LDAs of size-free LMM data from the four LMM protocols, include=FALSE}


#LDA of size-free LMM data for vd00

summary(PCAvd00sf) #determine the number of PCs to be used (95% of cumulative proportion)

PCvd00sf <- data.frame(PCAvd00sf$x[,1:4]) 

PCvd00sf$Population <- antechinusdatapop$Population

ldavd00sf <- lda(Population~., data = PCvd00sf, prior = c(1,1,1)/3)

ldsvd00sf <- predict(ldavd00sf)

dataldavd00sf <- data.frame(ldsvd00sf$x[,1], ldsvd00sf$x[,2], PCvd00sf$Population)

plotldavd00sf <- ggplot(dataldavd00sf, aes(x=ldsvd00sf.x...1., y=-ldsvd00sf.x...2., colour = PCvd00sf.Population)) +
  labs(x = "LD 1 (92.27%)", y = "LD 2 (7.73%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldavd00sf)


#LDA of size-free LMM data for d98

summary(PCAd98sf) #determine the number of PCs to be used (95% of cumulative proportion)

PCd98sf <- data.frame(PCAd98sf$x[,1:8]) 

PCd98sf$Population <- antechinusdatapop$Population

ldad98sf <- lda(Population~., data = PCd98sf, prior = c(1,1,1)/3)

ldsd98sf <- predict(ldad98sf)

dataldad98sf <- data.frame(ldsd98sf$x[,1], ldsd98sf$x[,2], PCd98sf$Population)

plotldad98sf <- ggplot(dataldad98sf, aes(x=ldsd98sf.x...1., y=ldsd98sf.x...2., colour = PCd98sf.Population)) +
  labs(x = "LD 1 (90.15%)", y = "LD 2 (9.85%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldad98sf)


#LDA of size-free LMM data for b13

summary(PCAb13sf) #determine the number of PCs to be used (95% of cumulative proportion)

PCb13sf <- data.frame(PCAb13sf$x[,1:6]) 

PCb13sf$Population <- antechinusdatapop$Population

ldab13sf <- lda(Population~., data = PCb13sf, prior = c(1,1,1)/3)

ldsb13sf <- predict(ldab13sf)

dataldab13sf <- data.frame(ldsb13sf$x[,1], ldsb13sf$x[,2], PCb13sf$Population)

plotldab13sf <- ggplot(dataldab13sf, aes(x=ldsb13sf.x...1., y=ldsb13sf.x...2., colour = PCb13sf.Population)) +
  labs(x = "LD 1 (91.31%)", y = "LD 2 (8.69%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldab13sf)


#LDA of size-free LMM data for t16

summary(PCAt16sf) #determine the number of PCs to be used (95% of cumulative proportion)

PCt16sf <- data.frame(PCAt16sf$x[,1:11]) 

PCt16sf$Population <- antechinusdatapop$Population

ldat16sf <- lda(Population~., data = PCt16sf, prior = c(1,1,1)/3)

ldst16sf <- predict(ldat16sf)

dataldat16sf <- data.frame(ldst16sf$x[,1], ldst16sf$x[,2], PCt16sf$Population)

plotldat16sf <- ggplot(dataldat16sf, aes(x=ldst16sf.x...1., y=ldst16sf.x...2., colour = PCt16sf.Population)) +
  labs(x = "LD 1 (85.53%)", y = "LD 2 (14.47%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldat16sf)



```

```{r, LDAs of allometry-corrected LMM data from the four LMM protocols, include=FALSE}


#LDA of allometry-corrected LMM data for vd00

summary(PCAvd00ac) #determine the number of PCs to be used (95% of cumulative proportion)

PCvd00ac <- data.frame(PCAvd00ac$x[,1:4]) 

PCvd00ac$Population <- antechinusdatapop$Population

ldavd00ac <- lda(Population~., data = PCvd00ac, prior = c(1,1,1)/3)

ldsvd00ac <- predict(ldavd00ac)

dataldavd00ac <- data.frame(ldsvd00ac$x[,1], ldsvd00ac$x[,2], PCvd00ac$Population)

plotldavd00ac <- ggplot(dataldavd00ac, aes(x=ldsvd00ac.x...1., y=-ldsvd00ac.x...2., colour = PCvd00ac.Population)) +
  labs(x = "LD 1 (86.7%)", y = "LD 2 (13.3%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldavd00ac)


#LDA of allometry-corrected LMM data for d98

summary(PCAd98ac) #determine the number of PCs to be used (95% of cumulative proportion)

PCd98ac <- data.frame(PCAd98ac$x[,1:9]) 

PCd98ac$Population <- antechinusdatapop$Population

ldad98ac <- lda(Population~., data = PCd98ac, prior = c(1,1,1)/3)

ldsd98ac <- predict(ldad98ac)

dataldad98ac <- data.frame(ldsd98ac$x[,1], ldsd98ac$x[,2], PCd98ac$Population)

plotldad98ac <- ggplot(dataldad98ac, aes(x=ldsd98ac.x...1., y=ldsd98ac.x...2., colour = PCd98ac.Population)) +
  labs(x = "LD 1 (71.75%)", y = "LD 2 (28.25%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldad98ac)


#LDA of allometry-corrected LMM data for b13

summary(PCAb13ac) #determine the number of PCs to be used (95% of cumulative proportion)

PCb13ac <- data.frame(PCAb13ac$x[,1:6]) 

PCb13ac$Population <- antechinusdatapop$Population

ldab13ac <- lda(Population~., data = PCb13ac, prior = c(1,1,1)/3)

ldsb13ac <- predict(ldab13ac)

dataldab13ac <- data.frame(ldsb13ac$x[,1], ldsb13ac$x[,2], PCb13ac$Population)

plotldab13ac <- ggplot(dataldab13ac, aes(x=ldsb13ac.x...1., y=ldsb13ac.x...2., colour = PCb13ac.Population)) +
  labs(x = "LD 1 (81.04%)", y = "LD 2 (18.96%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldab13ac)


#LDA of allometry-corrected LMM data for t16

summary(PCAt16ac) #determine the number of PCs to be used (95% of cumulative proportion)

PCt16ac <- data.frame(PCAt16ac$x[,1:12]) 

PCt16ac$Population <- antechinusdatapop$Population

ldat16ac <- lda(Population~., data = PCt16ac, prior = c(1,1,1)/3)

ldst16ac <- predict(ldat16ac)

dataldat16ac <- data.frame(ldst16ac$x[,1], ldst16ac$x[,2], PCt16ac$Population)

plotldat16ac <- ggplot(dataldat16ac, aes(x=-ldst16ac.x...1., y=ldst16ac.x...2., colour = PCt16ac.Population)) +
  labs(x = "LD 1 (77.87%)", y = "LD 2 (22.13%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldat16ac)



```

```{r, LDAs of GMM data, include=FALSE}

#LDA of raw GMM data

summary(PCAgmmraw)

PCgmmraw <- data.frame(PCAgmmraw$x[,1:22]) 

PCgmmraw$Population <- antechinusdatapop$Population

ldagmmraw <- lda(Population~., data = PCgmmraw, prior = c(1,1,1)/3)

ldsgmmraw <- predict(ldagmmraw)

dataldagmmraw <- data.frame(ldsgmmraw$x[,1], ldsgmmraw$x[,2], PCgmmraw$Population)

plotldagmmraw <- ggplot(dataldagmmraw, aes(x=ldsgmmraw.x...1., y=ldsgmmraw.x...2., colour = PCgmmraw.Population)) +
  labs(x = "LD 1 (82.45%)", y = "LD 2 (17.55%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldagmmraw)

#LDA of size-free GMM data (after Procrustes superimposition)

summary(PCAgmmgpa)

PCgmmsf <- data.frame(PCAgmmgpa$x[,1:65]) 

PCgmmsf$Population <- antechinusdatapop$Population

ldagmmsf <- lda(Population~., data = PCgmmsf, prior = c(1,1,1)/3)

ldsgmmsf <- predict(ldagmmsf)

dataldagmmsf <- data.frame(ldsgmmsf$x[,1], ldsgmmsf$x[,2], PCgmmsf$Population)

plotldagmmsf <- ggplot(dataldagmmsf, aes(x=ldsgmmsf.x...1., y=ldsgmmsf.x...2., colour = PCgmmsf.Population)) +
  labs(x = "LD 1 (77.51%)", y = "LD 2 (22.49%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldagmmsf)



#LDA of allometry-corrected GMM data 

summary(PCAgmmresiduals)

PCgmmac <- data.frame(PCAgmmresiduals$x[,1:68]) 

PCgmmac$Population <- antechinusdatapop$Population

ldagmmac <- lda(Population~., data = PCgmmac, prior = c(1,1,1)/3)

ldsgmmac <- predict(ldagmmac)

dataldagmmac <- data.frame(ldsgmmac$x[,1], ldsgmmac$x[,2], PCgmmac$Population)

plotldagmmac <- ggplot(dataldagmmac, aes(x=-ldsgmmac.x...1., y=ldsgmmac.x...2., colour = PCgmmac.Population)) +
  labs(x = "LD 1 (80.3%)", y = "LD 2 (19.7%)") +  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  stat_ellipse(size = 2, level = 0.95) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotldagmmac)

```



```{r, LDA Figure, include = FALSE}

library(ggpubr)

ldafigs <- ggarrange(plotldavd00raw, plotldavd00sf, plotldavd00ac, plotldad98raw, plotldad98sf, plotldad98ac, plotldab13raw, plotldab13sf, plotldab13ac, plotldat16raw, plotldat16sf, plotldat16ac, plotldagmmraw, plotldagmmsf, plotldagmmac, nrow = 5, ncol = 3, common.legend = TRUE, legend = "bottom")

plot(ldafigs) 

```

```{r, Uschi classification performance measures for LMM and GMM data, include = FALSE}

#classification performance measures for vd00

#raw

ldavd00rawcv <- lda(Population~., data = PCvd00raw, prior = c(1,1,1)/3, CV=TRUE)

factor.antepop <- as.factor(antechinusdatapop$Population)

ucpmvd00raw <- ucpm(ldavd00rawcv$posterior, factor.antepop)

ucpmvd00raw

#size-free

ldavd00sfcv <- lda(Population~., data = PCvd00sf, prior = c(1,1,1)/3, CV=TRUE)

ucpmvd00sf <- ucpm(ldavd00sfcv$posterior, factor.antepop)

ucpmvd00sf

#allometry-corrected

ldavd00accv <- lda(Population~., data = PCvd00ac, prior = c(1,1,1)/3, CV=TRUE)

ucpmvd00ac <- ucpm(ldavd00accv$posterior, factor.antepop)

ucpmvd00ac

#classification performance measures for d98

#raw

ldad98rawcv <- lda(Population~., data = PCd98raw, prior = c(1,1,1)/3, CV=TRUE)

ucpmd98raw <- ucpm(ldad98rawcv$posterior, factor.antepop)

ucpmd98raw

#size-free

ldad98sfcv <- lda(Population~., data = PCd98sf, prior = c(1,1,1)/3, CV=TRUE)

ucpmd98sf <- ucpm(ldad98sfcv$posterior, factor.antepop)

ucpmd98sf

#allometry-corrected

ldad98accv <- lda(Population~., data = PCd98ac, prior = c(1,1,1)/3, CV=TRUE)

ucpmd98ac <- ucpm(ldad98accv$posterior, factor.antepop)

ucpmd98ac

#classification performance measures for b13

#raw

ldab13rawcv <- lda(Population~., data = PCb13raw, prior = c(1,1,1)/3, CV=TRUE)

ucpmb13raw <- ucpm(ldab13rawcv$posterior, factor.antepop)

ucpmb13raw

#size-free

ldab13sfcv <- lda(Population~., data = PCb13sf, prior = c(1,1,1)/3, CV=TRUE)

ucpmb13sf <- ucpm(ldab13sfcv$posterior, factor.antepop)

ucpmb13sf

#allometry-corrected

ldab13accv <- lda(Population~., data = PCb13ac, prior = c(1,1,1)/3, CV=TRUE)

ucpmb13ac <- ucpm(ldab13accv$posterior, factor.antepop)

ucpmb13ac

#classification performance measures for t16

#raw

ldat16rawcv <- lda(Population~., data = PCt16raw, prior = c(1,1,1)/3, CV=TRUE)

ucpmt16raw <- ucpm(ldat16rawcv$posterior, factor.antepop)

ucpmt16raw

#size-free

ldat16sfcv <- lda(Population~., data = PCt16sf, prior = c(1,1,1)/3, CV=TRUE)

ucpmt16sf <- ucpm(ldat16sfcv$posterior, factor.antepop)

ucpmt16sf

#allometry-corrected

ldat16accv <- lda(Population~., data = PCt16ac, prior = c(1,1,1)/3, CV=TRUE)

ucpmt16ac <- ucpm(ldat16accv$posterior, factor.antepop)

ucpmt16ac

#classification performance measures for GMM

#raw

ldagmmrawcv <- lda(Population~., data = PCgmmraw, prior = c(1,1,1)/3, CV=TRUE)

ucpmgmmraw <- ucpm(ldagmmrawcv$posterior, factor.antepop)

ucpmgmmraw

#size-free

ldagmmsfcv <- lda(Population~., data = PCgmmsf, prior = c(1,1,1)/3, CV=TRUE)

ucpmgmmsf <- ucpm(ldagmmsfcv$posterior, factor.antepop)

ucpmgmmsf

#allometry-corrected

ldagmmaccv <- lda(Population~., data = PCgmmac, prior = c(1,1,1)/3, CV=TRUE)

ucpmgmmac <- ucpm(ldagmmaccv$posterior, factor.antepop)

ucpmgmmac



```


```{r, predictions of unknown specimens with raw data, include = FALSE}

#RAW

#vd00 raw

vd00_unknown <- vandyck2000[c(which(antechinusdata$Population=="?")),]

predspecvd00 <- predict(PCAvd00raw, newdata = vd00_unknown)

predspecvd00.df <- as.data.frame(predspecvd00)

ldapredvd00 <- predict(ldavd00raw, newdata = predspecvd00.df)

ldapredvd00$class

#d98 raw

d98_unknown <- dickman1998[c(which(antechinusdata$Population=="?")),]

predspecd98 <- predict(PCAd98raw, newdata = d98_unknown)

predspecd98.df <- as.data.frame(predspecd98)

ldapredd98 <- predict(ldad98raw, newdata = predspecd98.df)

ldapredd98$class

#b13 raw

b13_unknown <- baker2013[c(which(antechinusdata$Population=="?")),]

predspecb13 <- predict(PCAb13raw, newdata = b13_unknown)

predspecb13.df <- as.data.frame(predspecb13)

ldapredb13 <- predict(ldab13raw, newdata = predspecb13.df)

ldapredb13$class

#t16 raw

t16_unknown <- travouillon2016[c(which(antechinusdata$Population=="?")),]

predspect16 <- predict(PCAt16raw, newdata = t16_unknown)

predspect16.df <- as.data.frame(predspect16)

ldapredt16 <- predict(ldat16raw, newdata = predspect16.df)

ldapredt16$class

#getting maximum posterior probabilities for each specimen

vd00postdf <- as.data.frame(ldapredvd00$posterior)

vd00postdf$max <- apply(X = vd00postdf, MARGIN = 1, FUN = max)*100

vd00postdf$maxround <- as.factor(round(vd00postdf$max, digits = 2))

d98postdf <- as.data.frame(ldapredd98$posterior)

d98postdf$max <- apply(X = d98postdf, MARGIN = 1, FUN = max)*100

d98postdf$maxround <- as.factor(round(d98postdf$max, digits = 2))

b13postdf <- as.data.frame(ldapredb13$posterior)

b13postdf$max <- apply(X = b13postdf, MARGIN = 1, FUN = max)*100

b13postdf$maxround <- as.factor(round(b13postdf$max, digits = 2))

t16postdf <- as.data.frame(ldapredt16$posterior)

t16postdf$max <- apply(X = t16postdf, MARGIN = 1, FUN = max)*100

t16postdf$maxround <- as.factor(round(t16postdf$max, digits = 2))

#GMM RAW

#PCA of raw GMM data (unscaled or partial Procrustes superimposition) for all specimens

gpapprocall <- ProcGPA(A_reorder, scale = FALSE)

PCAgmmrawall <- gm.prcomp(gpapprocall$rotated)

summary(PCAgmmrawall)

#extraction of unknown specimens for lda model

PCgmmrawpop <- data.frame(PCAgmmrawall$x[-c(which(antechinusdata$Population=="?")),1:23])

PCgmmrawpop$Population <- antechinusdatapop$Population

ldagmmrawpop <- lda(Population~., data = PCgmmrawpop, prior = c(1,1,1)/3)

ldsgmmrawpop <- predict(ldagmmrawpop)

#prediction of unknown specimens

PCgmmrawunknown <- data.frame(PCAgmmrawall$x[c(which(antechinusdata$Population=="?")),1:23])

ldapredgmmraw <- predict(ldagmmrawpop, newdata = PCgmmrawunknown)

gmmrawpostdf <- as.data.frame(ldapredgmmraw$posterior)

gmmrawpostdf$max <- apply(X = gmmrawpostdf, MARGIN = 1, FUN = max)*100

gmmrawpostdf$maxround <- as.factor(round(gmmrawpostdf$max, digits = 2))


#building the table

matrix_rawpred <- matrix(c(ldapredvd00$class, vd00postdf$maxround, ldapredd98$class,d98postdf$maxround, ldapredb13$class, b13postdf$maxround, ldapredt16$class, t16postdf$maxround, ldapredgmmraw$class, gmmrawpostdf$maxround), ncol = 10, byrow = FALSE)

colnames(matrix_rawpred) <- c("vd00", "vd00 (%)", "d98", "d98 (%)", "b13", "b13 (%)", "t16", "t16 (%)", "gmm", "gmm (%)")

rownames(matrix_rawpred) <- rownames(vd00_unknown)

table_rawpred <- as.table(matrix_rawpred)

plot(table_rawpred)



```

```{r, predictions of unknown specimens with size-free data, include = FALSE}

#SIZE-FREE

#vd00 sf

vd00_unknownsf <- sizefree_dfvd00[c(which(antechinusdata$Population=="?")),]

predspecvd00sf <- predict(PCAvd00sf, newdata = vd00_unknownsf)

predspecvd00sf.df <- as.data.frame(predspecvd00sf)

ldapredvd00sf <- predict(ldavd00sf, newdata = predspecvd00sf.df)

ldapredvd00sf$class

#d98 sf

d98_unknownsf <- sizefree_dfd98[c(which(antechinusdata$Population=="?")),]

predspecd98sf <- predict(PCAd98sf, newdata = d98_unknownsf)

predspecd98sf.df <- as.data.frame(predspecd98sf)

ldapredd98sf <- predict(ldad98sf, newdata = predspecd98sf.df)

ldapredd98sf$class


#b13 sf

b13_unknownsf <- sizefree_dfb13[c(which(antechinusdata$Population=="?")),]

predspecb13sf <- predict(PCAb13sf, newdata = b13_unknownsf)

predspecb13sf.df <- as.data.frame(predspecb13sf)

ldapredb13sf <- predict(ldab13sf, newdata = predspecb13sf.df)

ldapredb13sf$class


#t16 sf

t16_unknownsf <- sizefree_dft16[c(which(antechinusdata$Population=="?")),]

predspect16sf <- predict(PCAt16sf, newdata = t16_unknownsf)

predspect16sf.df <- as.data.frame(predspect16sf)

ldapredt16sf <- predict(ldat16sf, newdata = predspect16sf.df)

ldapredt16sf$class


#getting maximum posterior probabilities for each specimen

vd00sfpostdf <- as.data.frame(ldapredvd00sf$posterior)

vd00sfpostdf$max <- apply(X = vd00sfpostdf, MARGIN = 1, FUN = max)*100

vd00sfpostdf$maxround <- as.factor(round(vd00sfpostdf$max, digits = 2))

d98sfpostdf <- as.data.frame(ldapredd98sf$posterior)

d98sfpostdf$max <- apply(X = d98sfpostdf, MARGIN = 1, FUN = max)*100

d98sfpostdf$maxround <- as.factor(round(d98sfpostdf$max, digits = 2))

b13sfpostdf <- as.data.frame(ldapredb13sf$posterior)

b13sfpostdf$max <- apply(X = b13sfpostdf, MARGIN = 1, FUN = max)*100

b13sfpostdf$maxround <- as.factor(round(b13sfpostdf$max, digits = 2))

t16sfpostdf <- as.data.frame(ldapredt16sf$posterior)

t16sfpostdf$max <- apply(X = t16sfpostdf, MARGIN = 1, FUN = max)*100

t16sfpostdf$maxround <- as.factor(round(t16sfpostdf$max, digits = 2))

#GMM sf

#PCA of sf GMM data (after full Procrustes superimposition) for all specimens


gpaprocall <- gpagen(A_reorder, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                  max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)


PCAgmmsfall <- gm.prcomp(gpaprocall$coords)

summary(PCAgmmsfall)

#extraction of unknown specimens for lda model

PCgmmsfpop <- data.frame(PCAgmmsfall$x[-c(which(antechinusdata$Population=="?")),1:71])

PCgmmsfpop$Population <- antechinusdatapop$Population

ldagmmsfpop <- lda(Population~., data = PCgmmsfpop, prior = c(1,1,1)/3)

ldsgmmsfpop <- predict(ldagmmsfpop)

#prediction of unknown specimens

PCgmmsfunknown <- data.frame(PCAgmmsfall$x[c(which(antechinusdata$Population=="?")),1:71])

ldapredgmmsf <- predict(ldagmmsfpop, newdata = PCgmmsfunknown)

gmmsfpostdf <- as.data.frame(ldapredgmmsf$posterior)

gmmsfpostdf$max <- apply(X = gmmsfpostdf, MARGIN = 1, FUN = max)*100

gmmsfpostdf$maxround <- as.factor(round(gmmsfpostdf$max, digits = 2))


#building the table

matrix_sfpred <- matrix(c(ldapredvd00sf$class, vd00sfpostdf$maxround, ldapredd98sf$class,d98sfpostdf$maxround, ldapredb13sf$class, b13sfpostdf$maxround, ldapredt16sf$class, t16sfpostdf$maxround, ldapredgmmsf$class, gmmsfpostdf$maxround), ncol = 10, byrow = FALSE)

colnames(matrix_sfpred) <- c("vd00", "vd00 (%)", "d98", "d98 (%)", "b13", "b13 (%)", "t16", "t16 (%)", "gmm", "gmm (%)")

rownames(matrix_sfpred) <- rownames(vd00_unknownsf)

table_sfpred <- as.table(matrix_sfpred)

plot(table_sfpred)


write.csv(table_rawpred, file = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/table_rawpred.csv")
write.csv(table_sfpred, file = "C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/table_sfpred.csv")

```
