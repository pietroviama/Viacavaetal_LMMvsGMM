---
title: "LMMvsGMM"
author: "Pietro Viacava"
date: "15/02/2021"
output: html_document
---
  
```{r, setup, include=FALSE}
knitr::opts_knit$set(root.dir = '../Viacavaetal_LMMvsGMM/Data', echo = FALSE)

#load libraries

library(MASS)
library(car)
library(ggplot2)
library(geomorph)
library(klaR)
library(EnvStats)
library(dplyr)
library(Morpho)


```


```{r, load 3D landmark data and perform gpa, include=FALSE}

#Import 3D coordinates from all specimens

coords.3D <- t (read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/Antechinus_semiLMcoords.csv", header = TRUE, row.names = 1))
dim(coords.3D) #check number of specimens and landmarks

#Convert 2D metadata into a 3D array

A <- arrayspecs(coords.3D, 412, 3)
dim(A)
Ahead <- head(dimnames(A))[3]

#Load the classifier

antechinusdata <- read.csv("C:/Users/pietro/Desktop/Pietro/Projects/Viacavaetal_LMMvsGMM/Data/Viacavaetal_LMMvsGMM_data.csv", header=T)
dim(antechinusdata) #check number of specimens


#give museum ID row names to antechinus data

rownames(antechinusdata)<-antechinusdata$ID

#Rearrange coordinate names and classifier file names in the same order

names_array <- dimnames(A)[[3]]
names_classifier <- rownames(antechinusdata)
match(names_array, names_classifier)
A_reorder <- A[,,match(names_classifier, names_array)]

names_Areorder <- dimnames(A_reorder)[[3]]
match(names_Areorder, names_classifier) #checking that the ID's correspond in both

#clean dataset, delete juveniles, other species and CM3642 for being a clear outlier

A_reorder <- A_reorder[,,-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642"))]

antechinusdata <- antechinusdata[-c(which(antechinusdata$Age=="Juvenile?"), which(antechinusdata$Population=="adustus?"), which(antechinusdata$Population=="agilis?"), which(antechinusdata$ID=="CM3642")),]
antechinusdata <- droplevels(antechinusdata) #we end up with 168 specimens


#load data of specimens with known population

A_reorderpop <- A_reorder[,,-c(which(antechinusdata$Population=="?"))]

antechinusdatapop <- antechinusdata[-c(which(antechinusdata$Population=="?")),]
antechinusdatapop <- droplevels(antechinusdatapop)


gpaallpop<-gpagen(A_reorderpop, curves = NULL, surfaces = NULL, PrinAxes = TRUE,
                  max.iter = NULL, ProcD = TRUE, Proj = TRUE, print.progress = TRUE)


```


```{r, extraction of linear measurements, include=FALSE}

#calculate linear measurements following the protocol of Van Dyck & Crowther, 2000

vandyck2000 <- data.frame(bl = (interlmkdist(A_reorder,c(6,10))), 
                          pl = (interlmkdist(A_reorder,c(7,10))), 
                          p1_3 = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                          swr_lc1a = (interlmkdist(A_reorder,c(25,26))),
                          c1m4 = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                          ipvl = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                          swr_lm3 = (interlmkdist(A_reorder,c(41,42))),
                          tc = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                          ibw = (interlmkdist(A_reorder,c(65,66))),
                          obw = (interlmkdist(A_reorder,c(45,46))),
                          apvl = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                          ppvl = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                          m1_4 = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2)



#calculate linear measurements following the protocol of Dickman et al., 1998

dickman1998 <- data.frame(con = (interlmkdist(A_reorder,c(6,10))), 
                          pal = (interlmkdist(A_reorder,c(7,10))), 
                          p1_3 = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                          swc = (interlmkdist(A_reorder,c(25,26))),
                          c1m4 = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                          m1_4 = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                          ipd = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                          swm3 = (interlmkdist(A_reorder,c(41,42))),
                          aw = (interlmkdist(A_reorder,c(71,72))),
                          tcd = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                          ibw = (interlmkdist(A_reorder,c(65,66))),
                          obm = (interlmkdist(A_reorder,c(45,46))),
                          pns = (interlmkdist(A_reorder,c(11,17)) + interlmkdist(A_reorder,c(12,18)))/2,
                          nwi = (interlmkdist(A_reorder,c(11,12))),
                          nl = (interlmkdist(A_reorder,c(1,2))),
                          now = (interlmkdist(A_reorder,c(19,20))),
                          gl = (interlmkdist(A_reorder,c(4,10))),
                          apv = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                          ppv = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                          fmh = (interlmkdist(A_reorder,c(5,6))),
                          fmw = (interlmkdist(A_reorder,c(55,56))))



#calculate linear measurements following the protocol of Baker et al., 2013

baker2013 <- data.frame(ht_b = sqrt(interlmkdist(A_reorder,c(3,69)))^2 - ((interlmkdist(A_reorder,c(69,70)))/2)^2, 
                        uml = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                        upl = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                        pml = sqrt(interlmkdist(A_reorder,c(10,17)))^2 - ((interlmkdist(A_reorder,c(17,18)))/2)^2,
                        I1_P3 = (interlmkdist(A_reorder,c(10,27)) + interlmkdist(A_reorder,c(10,28)))/2,
                        nw = (interlmkdist(A_reorder,c(17,18))),
                        nwr = (interlmkdist(A_reorder,c(19,20))),
                        apv = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                        ipv = (interlmkdist(A_reorder,c(77,79)) + interlmkdist(A_reorder,c(78,80)))/2,
                        ppv = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                        pl = (interlmkdist(A_reorder,c(7,10))),
                        bl = (interlmkdist(A_reorder,c(6,10))),
                        tc = (interlmkdist(A_reorder,c(67,68)) + interlmkdist(A_reorder,c(69,70)))/2,
                        ibw = (interlmkdist(A_reorder,c(65,66))),
                        R_LC1 = (interlmkdist(A_reorder,c(25,26))),
                        R_LM1T = (interlmkdist(A_reorder,c(27,28))),
                        R_LM3 = (interlmkdist(A_reorder,c(41,42))),
                        OBW = (interlmkdist(A_reorder,c(45,46))))



#calculate linear measurements following the protocol of Travouillon, 2016

travouillon2016 <- data.frame(onl = (interlmkdist(A_reorder,c(1,4))),
                              nl = (interlmkdist(A_reorder,c(2,10))),
                              anw = (interlmkdist(A_reorder,c(11,12))),
                              nps = (interlmkdist(A_reorder,c(11,17)) + interlmkdist(A_reorder,c(12,18)))/2,
                              pnw = (interlmkdist(A_reorder,c(19,20))),
                              rwi = (interlmkdist(A_reorder,c(29,31)) + interlmkdist(A_reorder,c(30,32)))/2,
                              fs = (interlmkdist(A_reorder,c(2,3))),
                              ppw = (interlmkdist(A_reorder,c(23,24))),
                              bcl = (interlmkdist(A_reorder,c(5,10))),
                              il = (interlmkdist(A_reorder,c(10,15)) + interlmkdist(A_reorder,c(10,16)))/2,
                              apw = (interlmkdist(A_reorder,c(79,80)) + interlmkdist(A_reorder,c(81,82)))/2,
                              apl = (interlmkdist(A_reorder,c(79,81)) + interlmkdist(A_reorder,c(80,82)))/2,
                              rwc = (interlmkdist(A_reorder,c(25,26))),
                              upr = (interlmkdist(A_reorder,c(25,27)) + interlmkdist(A_reorder,c(26,28)))/2,
                              ctl = (interlmkdist(A_reorder,c(25,37)) + interlmkdist(A_reorder,c(26,38)))/2,
                              umr = (interlmkdist(A_reorder,c(27,37)) + interlmkdist(A_reorder,c(28,38)))/2,
                              op3 = (interlmkdist(A_reorder,c(27,28))),
                              ppl = (interlmkdist(A_reorder,c(75,77)) + interlmkdist(A_reorder,c(76,78)))/2,
                              bol = (interlmkdist(A_reorder,c(61,65)) + interlmkdist(A_reorder,c(62,66)))/2,
                              mw = (interlmkdist(A_reorder,c(47,49))),
                              pow = (interlmkdist(A_reorder,c(59,60))),
                              cw = (interlmkdist(A_reorder,c(57,58))))



```


```{r, PCAs of raw LMM data from the four LMM protocols, include=FALSE}


#PCA for van dyck & crowther, 2000

PCAintlmvd00raw <-prcomp(vandyck2000[-c(which(antechinusdata$Population=="?")),])
summary(PCAintlmvd00raw)

dataPCAvd00raw <- data.frame(-PCAintlmvd00raw$x[,1], PCAintlmvd00raw$x[,2], antechinusdatapop$Population)

plotPCAvd00raw <- ggplot(dataPCAvd00raw, aes(x=X.PCAintlmvd00raw.x...1., y=PCAintlmvd00raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (81.54%)", y = "PC 2 (10.73%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00raw)


#PCA for dickman et al., 1998

PCAintlmd98raw <- prcomp(dickman1998[-c(which(antechinusdata$Population=="?")),])
summary(PCAintlmd98raw)

dataPCAd98raw <- data.frame(-PCAintlmd98raw$x[,1], PCAintlmd98raw$x[,2], antechinusdatapop$Population)

plotPCAd98raw <- ggplot(dataPCAd98raw, aes(x=X.PCAintlmd98raw.x...1., y=-PCAintlmd98raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (77.55%)", y = "PC 2 (8.8%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98raw)


#PCA for baker et al., 2013

PCAintlmb13raw <- prcomp(baker2013[-c(which(antechinusdata$Population=="?")),])
summary(PCAintlmb13raw)

dataPCAb13raw <- data.frame(-PCAintlmb13raw$x[,1], -PCAintlmb13raw$x[,2], antechinusdatapop$Population)

plotPCAb13raw <- ggplot(dataPCAb13raw, aes(x=X.PCAintlmb13raw.x...1., y=X.PCAintlmb13raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (75.82%)", y = "PC 2 (9.74%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13raw)


#PCA for travouillon, 2016

PCAintlmt16raw <- prcomp(travouillon2016[-c(which(antechinusdata$Population=="?")),])
summary(PCAintlmt16raw)

dataPCAt16raw <- data.frame(-PCAintlmt16raw$x[,1], PCAintlmt16raw$x[,2], antechinusdatapop$Population)

plotPCAt16raw <- ggplot(dataPCAt16raw, aes(x=X.PCAintlmt16raw.x...1., y=PCAintlmt16raw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (73.36%)", y = "PC 2 (7.71%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16raw)



```

```{r, PCAs of size-free LMM data from the four LMM protocols, include=FALSE}


#van dyck & crowther, 2000

#calculation of the geometric mean for each specimen

gmeansvd00 <- apply(vandyck2000, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.vd00 <- log10(vandyck2000/gmeansvd00)

#integration into a dataframe with information on population ID

sizefree_dfvd00 <- data.frame(shaperatio.vd00, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAintlmvd00 <- prcomp(sizefree_dfvd00[-c(which(antechinusdata$Population=="?")),1:13])
summary(PCAintlmvd00)


dataPCAvd00 <- data.frame(PCAintlmvd00$x[,1], PCAintlmvd00$x[,2], antechinusdatapop$Population)

plotPCAvd00 <- ggplot(dataPCAvd00, aes(x=PCAintlmvd00.x...1., y=PCAintlmvd00.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (89.12%)", y = "PC 2 (3.23%)") +
  scale_color_manual(values = c( "#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00)

#dickman et al., 1998

#calculation of the geometric mean for each specimen

gmeansd98 <- apply(dickman1998, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.d98 <- log10(dickman1998/gmeansd98) 

#integration into a dataframe with information on population ID

sizefree_dfd98 <- data.frame(shaperatio.d98, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAintlmd98 <- prcomp(sizefree_dfd98[-c(which(antechinusdata$Population=="?")),1:21])
summary(PCAintlmd98)

dataPCAd98 <- data.frame(PCAintlmd98$x[,1], PCAintlmd98$x[,2], antechinusdatapop$Population)

plotPCAd98 <- ggplot(dataPCAd98, aes(x=PCAintlmd98.x...1., y=PCAintlmd98.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (75.67%)", y = "PC 2 (4.55%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98)

#PCA for baker et al., 2013

#calculation of the geometric mean for each specimen

gmeansb13 <- apply(baker2013, 1, geoMean) 

#freeing size with calculation of shape ratios

shaperatio.b13 <- log10(baker2013/gmeansb13) 

#integration into a dataframe with information on population ID

sizefree_dfb13 <- data.frame(shaperatio.b13, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAintlmb13 <- prcomp(sizefree_dfb13[-c(which(antechinusdata$Population=="?")),1:18])
summary(PCAintlmb13)

dataPCAb13 <- data.frame(PCAintlmb13$x[,1], PCAintlmb13$x[,2], antechinusdatapop$Population)

plotPCAb13 <- ggplot(dataPCAb13, aes(x=PCAintlmb13.x...1., y=PCAintlmb13.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (78.13%)", y = "PC 2 (6.26%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13)


#travouillon, 2016

#calculation of the geometric mean for each specimen

gmeanst16 <- apply(travouillon2016, 1, geoMean)

#freeing size with calculation of shape ratios

shaperatio.t16 <- log10(travouillon2016/gmeanst16) 

#integration into a dataframe with information on population ID

sizefree_dft16 <- data.frame(shaperatio.t16, Population=antechinusdata$Population, ID=antechinusdata$ID) 

#PCA

PCAintlmt16 <- prcomp(sizefree_dft16[-c(which(antechinusdata$Population=="?")),1:22])
summary(PCAintlmt16)

dataPCAt16 <- data.frame(PCAintlmt16$x[,1], PCAintlmt16$x[,2], antechinusdatapop$Population)

plotPCAt16 <- ggplot(dataPCAt16, aes(x=PCAintlmt16.x...1., y=-PCAintlmt16.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (38.33%)", y = "PC 2 (12.2%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16)

```

```{r, PCAs of allometry-free LMM data from the four LMM protocols, include=FALSE}

#checking for allometry in vd00

gmeansvd00.pop <- as.data.frame(gmeansvd00[-c(which(antechinusdata$Population=="?"))])
names(gmeansvd00.pop)[names(gmeansvd00.pop) == 'gmeansvd00[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansvd00.pop'

rdf.vd00 <- rrpp.data.frame(cbind(sizefree_dfvd00[-c(which(antechinusdata$Population=="?")),1:13], gmeansvd00.pop))

fitdata.vd00 <- as.matrix(cbind(rdf.vd00$bl, rdf.vd00$pl, rdf.vd00$p1_3, rdf.vd00$swr_lc1a, rdf.vd00$c1m4, rdf.vd00$ipvl, rdf.vd00$swr_lm3, rdf.vd00$tc, rdf.vd00$ibw, rdf.vd00$obw, rdf.vd00$apvl, rdf.vd00$ppvl, rdf.vd00$m1_4))

rdf.vd00$LMM <- fitdata.vd00

fit.vd00 <- lm.rrpp(LMM~gmeansvd00.pop, data = rdf.vd00)

anova(fit.vd00)

#PCA of allometry-corrected data in vd00

PCAvd00res <- prcomp(fit.vd00$LM$residuals)


summary(PCAvd00res)

dataPCAvd00res <- data.frame(PCAvd00res$x[,1], PCAvd00res$x[,2], antechinusdatapop$Population)

plotPCAvd00res <- ggplot(dataPCAvd00res, aes(x=PCAvd00res.x...1., y=PCAvd00res.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (88.63%)", y = "PC 2 (3.42%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAvd00res)


#checking for allometry in d98

gmeansd98.pop <- as.data.frame(gmeansd98[-c(which(antechinusdata$Population=="?"))])
names(gmeansd98.pop)[names(gmeansd98.pop) == 'gmeansd98[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansd98.pop'

rdf.d98 <- rrpp.data.frame(cbind(sizefree_dfd98[-c(which(antechinusdata$Population=="?")),1:21], gmeansd98.pop))

fitdata.d98 <- as.matrix(cbind(rdf.d98$con, rdf.d98$pal, rdf.d98$p1_3, rdf.d98$swc, rdf.d98$c1m4, rdf.d98$m1_4, rdf.d98$ipd, rdf.d98$swm3, rdf.d98$aw, rdf.d98$tcd, rdf.d98$ibw, rdf.d98$obm, rdf.d98$pns, rdf.d98$nwi, rdf.d98$nl, rdf.d98$now, rdf.d98$gl, rdf.d98$apv, rdf.d98$ppv, rdf.d98$fmh, rdf.d98$fmw))

rdf.d98$LMM <- fitdata.d98

fit.d98 <- lm.rrpp(LMM~gmeansd98.pop, data = rdf.d98)

anova(fit.d98)

#PCA of allometry-corrected data in d98

PCAd98res <- prcomp(fit.d98$LM$residuals)


summary(PCAd98res)

dataPCAd98res <- data.frame(PCAd98res$x[,1], PCAd98res$x[,2], antechinusdatapop$Population)

plotPCAd98res <- ggplot(dataPCAd98res, aes(x=PCAd98res.x...1., y=-PCAd98res.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (73.87%)", y = "PC 2 (4.89%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAd98res)



#checking for allometry in b13

gmeansb13.pop <- as.data.frame(gmeansb13[-c(which(antechinusdata$Population=="?"))])
names(gmeansb13.pop)[names(gmeansb13.pop) == 'gmeansb13[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeansb13.pop'

rdf.b13 <- rrpp.data.frame(cbind(sizefree_dfb13[-c(which(antechinusdata$Population=="?")),1:18], gmeansb13.pop))

fitdata.b13 <- as.matrix(cbind(rdf.b13$ht_b, rdf.b13$uml, rdf.b13$upl, rdf.b13$pml, rdf.b13$I1_P3, rdf.b13$nw, rdf.b13$nwr, rdf.b13$apv, rdf.b13$ipv, rdf.b13$ppv, rdf.b13$pl, rdf.b13$bl, rdf.b13$tc, rdf.b13$ibw, rdf.b13$R_LC1, rdf.b13$R_LM1T, rdf.b13$R_LM3, rdf.b13$OBW))

rdf.b13$LMM <- fitdata.b13

fit.b13 <- lm.rrpp(LMM~gmeansb13.pop, data = rdf.b13)

anova(fit.b13)

#PCA of allometry-corrected data in b13

PCAb13res <- prcomp(fit.b13$LM$residuals)


summary(PCAb13res)

dataPCAb13res <- data.frame(PCAb13res$x[,1], PCAb13res$x[,2], antechinusdatapop$Population)

plotPCAb13res <- ggplot(dataPCAb13res, aes(x=PCAb13res.x...1., y=-PCAb13res.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (76.36%)", y = "PC 2 (6.88%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAb13res)


#checking for allometry in t16

gmeanst16.pop <- as.data.frame(gmeanst16[-c(which(antechinusdata$Population=="?"))])
names(gmeanst16.pop)[names(gmeanst16.pop) == 'gmeanst16[-c(which(antechinusdata$Population == "?"))]'] <- 'gmeanst16.pop'

rdf.t16 <- rrpp.data.frame(cbind(sizefree_dft16[-c(which(antechinusdata$Population=="?")),1:22], gmeanst16.pop))

fitdata.t16 <- as.matrix(cbind(rdf.t16$onl, rdf.t16$nl, rdf.t16$anw, rdf.t16$nps, rdf.t16$pnw, rdf.t16$rwi, rdf.t16$fs, rdf.t16$ppw, rdf.t16$bcl, rdf.t16$il, rdf.t16$apw, rdf.t16$apl, rdf.t16$rwc, rdf.t16$upr, rdf.t16$ctl, rdf.t16$umr, rdf.t16$op3, rdf.t16$ppl, rdf.t16$bol, rdf.t16$mw, rdf.t16$pow, rdf.t16$cw))

rdf.t16$LMM <- fitdata.t16

fit.t16 <- lm.rrpp(LMM~gmeanst16.pop, data = rdf.t16)

anova(fit.t16)

#PCA of allometry-corrected data in t16

PCAt16res <- prcomp(fit.t16$LM$residuals)


summary(PCAt16res)

dataPCAt16res <- data.frame(PCAt16res$x[,1], PCAt16res$x[,2], antechinusdatapop$Population)

plotPCAt16res <- ggplot(dataPCAt16res, aes(x=PCAt16res.x...1., y=PCAt16res.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (24.61%)", y = "PC 2 (15.16%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAt16res)


```
```{r, PCAs for GMM data, include = FALSE}

#PCA of raw GMM data (unscaled or partial Procrustes superimposition)

gpapproc <- ProcGPA(A_reorderpop, scale = FALSE)

PCAgmmraw <- gm.prcomp(gpapproc$rotated)
summary(PCAgmmraw)


dataPCAgmmraw <- data.frame(-PCAgmmraw$x[,1], PCAgmmraw$x[,2], antechinusdatapop$Population)

plotPCAgmmraw <- ggplot(dataPCAgmmraw, aes(x=X.PCAgmmraw.x...1., y=-PCAgmmraw.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (78.77%)", y = "PC 2 (3.12%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmraw)

#PCA of GMM data after Procrustes superimposition

PCAgmmgpa <- gm.prcomp(gpaallpop$coords) 

summary(PCAgmmgpa)

dataPCAgmmgpa <- data.frame(PCAgmmgpa$x[,1], -PCAgmmgpa$x[,2], antechinusdatapop$Population)

plotPCAgmmgpa <- ggplot(dataPCAgmmgpa, aes(x=PCAgmmgpa.x...1., y=X.PCAgmmgpa.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (19.43%)", y = "PC 2 (10.71%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmgpa)

#PCA of GMM data after allometric correction

fit.sizegmm <- procD.lm(f1 = gpaallpop$coords~log(gpaallpop$Csize),  print.progress = FALSE)

PCAgmmresiduals <- gm.prcomp(fit.sizegmm$residuals)
summary(PCAgmmresiduals)

dataPCAgmmresiduals <- data.frame(PCAgmmresiduals$x[,1], PCAgmmresiduals$x[,2], antechinusdatapop$Population)

plotPCAgmmresiduals <- ggplot(dataPCAgmmresiduals, aes(x=PCAgmmresiduals.x...1., y=PCAgmmresiduals.x...2., colour = antechinusdatapop.Population)) +
  labs(x = "PC 1 (14.78%)", y = "PC 2 (11.27%)") +
  scale_color_manual(values = c("#332288", "#CC6677", "#999933")) +
  geom_point(size = 4, alpha = 0.8) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), legend.title = element_blank(), axis.title.x = element_text(size = 15), axis.title.y = element_text(size = 15), axis.text = element_blank(), legend.position = "none")
plot(plotPCAgmmresiduals)


```




```{r, PCA Figure, include = FALSE}

library(ggpubr)

PCAfigs <- ggarrange(plotPCAvd00raw, plotPCAvd00, plotPCAvd00res, plotPCAd98raw, plotPCAd98, plotPCAd98res, plotPCAb13raw, plotPCAb13, plotPCAb13res, plotPCAt16raw, plotPCAt16, plotPCAt16res, plotPCAgmmraw, plotPCAgmmgpa, plotPCAgmmresiduals, nrow = 5, ncol = 3, common.legend = TRUE, legend = "bottom")

plot(PCAfigs) 

```


